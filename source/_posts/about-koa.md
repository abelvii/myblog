---
title: 黑盒分析koa
date: 2018-10-16 14:07:30
categories: 技术
tags: nodejs
---

突然心血来潮想看一看koa的源码，因为koa非常非常轻量级，所以对它的设计思想非常感兴趣。

到底要用什么样的设计来保证这个框架是可扩展以及可靠的？
<!--more-->
# 一些基础
在很多http模块的介绍中都会出现一些简单的代码，不过帮助我们理解整个http请求的流程已经足够了。

监听的端口接收到请求->运行http.createserver中传入的回调函数

在回调函数中有两个参数，分别是res和req，对应response和request，以request.end()方法作为一次http请求在前端方面的结束。

至于为什么说是在前端方面，因为我们可以在end方法调用之后再进行一些操作，比如计数等一些统计。
# middleware
根据我自己使用koa做的一些测试，koa的中间件其实是用的层层调用的方式进行调用。
类似于：
```
mw1()
  somecode;
  mw2()
    somecode;
    mw3()
      somecode;
    othercode;
  othercode;
```
这种运行方式后产生的结果。

koa的官方example中使用了async以及await，这两个关键词是用于node中的异步操作。

我们应该知道await关键词只能用在async关键词修饰的函数中，await后必须跟一个promise对象等等的一些东西。

所以在调用中间件时使用了promise。
# 对比
相对它的上一代框架express在整体的流程设计上不相同
```
koa: 请求->中间件
express: 请求->中间件->路由表
```
虽然在整体设计上不相同，但是其实相当于把路由功能舍弃掉，并且将这个功能交由用户选择性的加入到系统当中。

相对于一些轻量级的系统，请求的速度会更快一些，毕竟省去了解析url的时间（虽然也很快）。

目前想到的大概就是这些。更多内容等读过了源码之后再进行总结~

cheers！
